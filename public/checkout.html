<!doctype html>
<html lang="en">
<head>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <meta charset="utf-8">
  <link rel="icon" type="image/x-icon" href="images/logo-transparent.png">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Panier - VertiFlow</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;300;400;700;900&display=swap" rel="stylesheet">
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="css/bootstrap-icons.css" rel="stylesheet">
  <link href="css/tooplate-little-fashion.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
  <style>
    @media (max-width: 767px) {
      /* Aérer et centrer les éléments du panier */
      .cart-item {
        padding: 20px;
        margin-bottom: 20px;
        text-align: center;
      }
      .cart-item img {
        margin: 0 auto;
        display: block;
      }
      .cart-item h5,
      .cart-item p {
        margin: 10px 0;
      }
  
      /* Centrer le total et les détails */
      .cart-total {
        text-align: center;
        margin-top: 20px;
      }
  
      /* Aérer le formulaire de checkout */
      .checkout-form {
        padding: 20px;
        margin: 0 auto;
      }
  
      /* Centrer le bouton de validation */
      .btn-primary {
        display: block;
        width: 100%;
        margin-top: 10px;
      }
  
      /* Ajuster l'espacement du formulaire */
      .checkout-form .form-control {
        padding: 12px;
        font-size: 16px;
      }
  
      /* Espacement général */
      .container {
        padding-left: 15px;
        padding-right: 15px;
      }
    }
  </style>
  
  <style>
    .checkout-form {
      background-color: #f8f9fa;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
    }
    .checkout-form h2 {
      color: #333;
      margin-bottom: 30px;
      text-align: center;
    }
    .form-control {
      border-radius: 10px;
    }
    .btn-primary {
      background-color: #0d6efd;
      border: none;
      border-radius: 10px;
      padding: 10px 20px;
      font-weight: bold;
      transition: all 0.3s ease;
    }
    .btn-primary:hover {
      background-color: #0b5ed7;
      transform: translateY(-2px);
    }
    .cart-item {
      background-color: #fff;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
    }
    .cart-item img {
      max-width: 80px;
      border-radius: 5px;
    }
  </style>
</head>
<body>

  <main>

      <nav class="navbar navbar-expand-lg">
          <div class="container">
              <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                  <span class="navbar-toggler-icon"></span>
              </button>

              <a class="navbar-brand" href="index.html">
                  <strong><span>Verti</span> Flow</strong>
              </a>

              <div class="d-lg-none">
                  <!-- <a href="sign-in.html" class="bi-person custom-icon me-3"></a>
-->
              <a href="checkout.html" class="bi-bag custom-icon" data-count="0"></a>
              </div>

              <div class="collapse navbar-collapse" id="navbarNav">
                  <ul class="navbar-nav mx-auto">
                      <li class="nav-item">
                          <a class="nav-link active" href="index.html">Accueil</a>
                      </li>

                      <li class="nav-item">
                          <a class="nav-link" href="about.html">L'Origine</a>
                      </li>

                      <li class="nav-item">
                          <a class="nav-link" href="products.html">Boutique</a>
                      </li>

                      <li class="nav-item">
                          <a class="nav-link" href="blog.html">Blog</a>
                      </li>

                      <li class="nav-item">
                          <a class="nav-link" href="faq.html">FAQs</a>
                      </li>

                      <li class="nav-item">
                          <a class="nav-link" href="contact.html">Contact</a>
                      </li>
                  </ul>

                  <div class="d-none d-lg-block">
                      <!-- <a href="sign-in.html" class="bi-person custom-icon me-3"></a> -->

                      <a href="checkout.html" class="bi-bag custom-icon" data-count="0"></a>
                  </div>
              </div>
          </div>
      </nav>
  <main>
    <section class="checkout-section section-padding">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-12 mx-auto">
            <div class="checkout-form">
              <h2>Panier</h2>
              <div id="cart-items">
                <!-- Les articles du panier seront insérés ici -->
              </div>
              <form id="checkout-form">
                <div class="mb-3">
                  <label for="name" class="form-label">Nom Complet</label>
                  <input type="text" class="form-control" id="name" required>
                </div>
                <div class="mb-3">
                  <label for="email" class="form-label">Adresse Mail</label>
                  <input type="email" class="form-control" id="email" required>
                </div>
                <div class="mb-3">
                  <label for="address" class="form-label">Adresse</label>
                  <input type="text" class="form-control" id="address" required>
                </div>
                <div class="mb-3">
                  <label for="city" class="form-label">Ville</label>
                  <input type="text" class="form-control" id="city" required>
                </div>
                <div class="mb-3">
                  <label for="zip" class="form-label">Code Postal</label>
                  <input type="text" class="form-control" id="zip" required>
                </div>
                <div class="mb-3">
                  <label for="country" class="form-label">Pays</label>
                  <select class="form-select" id="country" required>
                    <option value="">Selectionnez un pays</option>
                    <option value="FR">France</option>
                    <option value="US">United States</option>
                    <option value="CA">Canada</option>
                    <option value="UK">United Kingdom</option>
                    <option value="DE">Germany</option>
                    <option value="IT">Italy</option>
                    <option value="ES">Spain</option>
                    <option value="AU">Australia</option>
                    <option value="IN">India</option>
                    <option value="JP">Japan</option>
                    <option value="BR">Brazil</option>
                    <option value="MX">Mexico</option>
                    <option value="RU">Russia</option>
                    <option value="CN">China</option>
                    <option value="SE">Sweden</option>
                    <option value="NL">Netherlands</option>
                    <option value="BE">Belgium</option>
                    <option value="AT">Austria</option>
                    <option value="CH">Switzerland</option>
                    <option value="FI">Finland</option>
                    <option value="DK">Denmark</option>
                    <option value="NO">Norway</option>
                    <option value="PL">Poland</option>
                  </select>                  
                </div>
                <div class="mb-3">
                  <label for="promo-code" class="form-label">Code Promo</label>
                  <input type="text" class="form-control" id="promo-code" placeholder="Entrez votre code promo">
                </div>
                <button type="submit" class="btn btn-primary w-100">Valider vos informations</button>
              </form>

              <!-- Conteneur pour le Payment Element et le bouton de paiement -->
              <div id="payment-container" style="display:none; margin-top:20px;">
                <div id="payment-element"></div>
                <button id="submit-payment" class="btn btn-primary w-100" style="margin-top:10px;"></button>
              </div>

            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container">
        <div class="row">

            <div class="col-lg-3 col-10 me-auto mb-4">
                <h4 class="text-white mb-3"><a href="index.html">Verti</a> Flow</h4>
                <p class="copyright-text text-muted mt-lg-5 mb-4 mb-lg-0">Copyright © 2025 <strong>VertiFlow</strong></p>
                <br>
                <p class="copyright-text">Made by <a href="https://airkyzzz.github.io/" target="_blank">AirKyzzZ</a></p>
            </div>

            <div class="col-lg-5 col-8">
                <h5 class="text-white mb-3">Naviguer</h5>

                <ul class="footer-menu d-flex flex-wrap">
                    <li class="footer-menu-item"><a href="index.html" class="footer-menu-link">Accueil</a></li>

                    <li class="footer-menu-item"><a href="about.html" class="footer-menu-link">L'Origine</a></li>

                    <li class="footer-menu-item"><a href="products.html" class="footer-menu-link">Boutique</a></li>

                    <li class="footer-menu-item"><a href="blog.html" class="footer-menu-link">Blog</a></li>

                    <li class="footer-menu-item"><a href="faq.html" class="footer-menu-link">FAQs</a></li>

                    <li class="footer-menu-item"><a href="contact.html" class="footer-menu-link">Contact</a></li>

                    <li class="footer-menu-item"><a href="mentions-legales.html" class="footer-menu-link">Mentions légales</a></li>

                    <li class="footer-menu-item"><a href="conditions-generales-de-vente.html" class="footer-menu-link">Conditions générales de vente</a></li>

                    <li class="footer-menu-item"><a href="politique-de-confidentialite.html" class="footer-menu-link">Politique de confidentialité</a></li>

                    <li class="footer-menu-item"><a href="conditions-utilisation.html" class="footer-menu-link">Conditions d’utilisation</a></li>

                    <li class="footer-menu-item"><a href="propriete-intellectuelle.html" class="footer-menu-link">Propriété intellectuelle</a></li>

                    <li class="footer-menu-item"><a href="accessibilite.html" class="footer-menu-link">Accessibilité</a></li>
                </ul>
            </div>

            <div class="col-lg-3 col-4">
                <h5 class="text-white mb-3">Réseaux Sociaux</h5>

                <ul class="social-icon">

                    <li><a href="https://www.instagram.com/vertiflowfreerun/" class="social-icon-link bi-instagram"></a></li>
                    <li><a href="https://www.tiktok.com/@vertiflow" class="social-icon-link bi-tiktok"></a></li>
                </ul>
            </div>

        </div>
    </div>
</footer>

  <script src="js/jquery.min.js"></script>
  <script src="js/bootstrap.bundle.min.js"></script>
  <script src="https://js.stripe.com/v3/"></script>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

  <script>
    // Initialisation de Stripe avec votre clé publique
    const stripe = Stripe('pk_live_51Qw8utImMzY0wzqJq3XWQMeZQtYhTycdzcBjBjOqlCJuHDs9zNSwf1jamRIcLOWM8Xgwjxt4b2JUJ08fuqJ1utJN00jRe8WGxJ');

    // Initialisation d'EmailJS (remplacez "z4uG1w3b8JueLdvkV" par votre identifiant EmailJS)
    emailjs.init("z4uG1w3b8JueLdvkV");

    $(document).ready(function() {
      // Chargement du panier
      let cart = JSON.parse(localStorage.getItem('cart')) || [];
      const cartItemsContainer = $('#cart-items');
      let total = 0;

      // Affichage des articles du panier
// Affichage des articles du panier
cart.forEach(item => {
  const itemTotal = item.price * item.quantity;
  total += itemTotal; // Ajout de cette ligne pour cumuler le total
  // Modifiez le template du panier pour inclure la couleur
// Modifiez cette partie du code d'affichage du panier
cartItemsContainer.append(`
    <div class="cart-item">
      <div class="row align-items-center">
        <div class="col-12 col-md-3 text-center">
          <img src="${item.image}" alt="${item.name}" class="img-fluid">
        </div>
        <div class="col-12 col-md-6">
          <h5>${item.name}</h5>
          <p>Taille: ${item.size}, Couleur: ${item.color}, Quantité: ${item.quantity}</p>
        </div>
        <div class="col-12 col-md-3 text-end">
          <p>${itemTotal.toFixed(2)}€</p>
          <button class="btn btn-danger btn-sm remove-btn" 
                  data-id="${item.id}" 
                  data-size="${item.size}"
                  data-color="${item.color}">Supprimer</button>
        </div>
      </div>
    </div>
`);
});



      // Affichage du total du panier
      if (cart.length > 0) {
  const shipping = 6.99;    // Frais de livraison
  const finalTotal = total + shipping;

  cartItemsContainer.append(`
    <div class="cart-total mt-3">
      <h4 class="text-end">Total: ${finalTotal.toFixed(2)}€</h4>
      <p class="text-end" style="font-size:0.8em; margin:0;">
        Livraison rapide : ${shipping.toFixed(2)}€
      </p>
    </div>
  `);
}


      // Gestion du formulaire de checkout
      $('#checkout-form').submit(async function(e) {
        e.preventDefault();

        // Récupérer les informations utilisateur saisies dans le formulaire
        // Dans la gestion du formulaire (submit event)
const customerInfo = {
  name: $('#name').val(),
  email: $('#email').val(),
  address: $('#address').val(),
  city: $('#city').val(),
  zip: $('#zip').val(),
  country: $('#country option:selected').text() // Récupère le nom du pays
};

    // Recharger le panier et recalculer le total
    cart = JSON.parse(localStorage.getItem('cart')) || [];
        total = 0;
        cart.forEach(item => {
          total += item.price * item.quantity;
        });
        const shipping = cart.length > 0 ? 6.99 : 0;
        let finalTotal = total + shipping;


    const promoCode = $('#promo-code').val().trim();
        if (promoCode.toUpperCase() === 'METZ57') {
          finalTotal = finalTotal * 0.85; // Appliquer une réduction de 15%
          console.log('Code promo valide : réduction appliquée');
        }

    // Montant en centimes pour Stripe
    const amount = Math.round(finalTotal * 100);


        try {
          // Appeler la fonction Netlify pour créer le PaymentIntent
          const response = await fetch('/.netlify/functions/create-payment-intent', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ amount, customerInfo }),
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Erreur serveur');
          }

          const { clientSecret } = await response.json();

          // Masquer le formulaire de checkout
          $('#checkout-form').hide();

          // Afficher le conteneur de paiement
          $('#payment-container').show();

          // Afficher le Payment Element avec le montant sur le bouton
          showPaymentElement(clientSecret, finalTotal, customerInfo, cart);
        } catch (error) {
          console.error('Erreur:', error);
          alert(`Erreur: ${error.message}`);
        }
      });

      // Suppression d'article du panier
      // Modifiez la gestion de la suppression pour tenir compte de la couleur
$(document).on('click', '.remove-btn', function() {
    const itemId = $(this).data('id');
    const itemSize = $(this).data('size');
    const itemColor = $(this).data('color');
    
    const newCart = cart.filter(item => 
        !(item.id === itemId && 
          item.size === itemSize && 
          item.color === itemColor)
    );
    
    localStorage.setItem('cart', JSON.stringify(newCart));
    location.reload();
});


      // Fonction pour afficher le Payment Element
      function showPaymentElement(clientSecret, finalTotal, customerInfo, cart) {
        console.log("showPaymentElement appelé avec clientSecret:", clientSecret);

        const elements = stripe.elements({ clientSecret, appearance: {} });
        const options = {
          layout: {
            type: 'accordion',
            defaultCollapsed: false,
            radios: false,
            spacedAccordionItems: true,
          }
        };
        const paymentElement = elements.create('payment', options);
        paymentElement.mount('#payment-element');

        const submitBtn = document.getElementById('submit-payment');
        submitBtn.style.display = 'block';
        submitBtn.textContent = `Payer ${finalTotal.toFixed(2)} €`;

          submitBtn.onclick = async () => {
  try {
    const { error, paymentIntent } = await stripe.confirmPayment({
      elements,
      confirmParams: { return_url: 'https://vertiflow.fr/success.html' },
      redirect: 'if_required'
    });

    if (error) throw error;

    if (paymentIntent?.status === 'succeeded') {
      await sendConfirmationEmail(customerInfo, finalTotal, cart);
      window.location.href = 'https://vertiflow.fr/success.html';
    }
  } catch (error) {
    console.error("Erreur de paiement :", error);
    alert(`Paiement échoué : ${error.message}`);
  }
};

      // Fonction d'envoi d'e-mail via EmailJS
      // Remplacez tous les identifiants par vos vraies valeurs EmailJS
        emailjs.init("z4uG1w3b8JueLdvkV"); // Remplacer VOTRE_USER_ID

        async function sendConfirmationEmail(customerInfo, finalTotal, cart) {
  try {
    const templateParams = {
      name: customerInfo.name,
      email: customerInfo.email,
      address: `${customerInfo.address}, ${customerInfo.zip} ${customerInfo.city}, ${customerInfo.country}`,
      total: finalTotal.toFixed(2),
      cartItems: cart.map(item => `
        <tr>
            <td>${item.name} (Taille ${item.size}, ${item.color})</td>
            <td>${item.quantity}</td>
            <td>${(item.price * item.quantity).toFixed(2)}€</td>
        </tr>
    `).join("")
    };

    console.log("📨 Tentative d'envoi d'email...");
    
    const response = await emailjs.send(
      "service_zulomgw", // Remplacer par votre Service ID
      "template_22lvzgl", // Remplacer par votre Template ID
      templateParams
    );
    
    console.log("✅ Email envoyé avec succès :", response);
    return true;
  } catch (error) {
    console.error("❌ Erreur d'envoi d'email :", error);
    throw error;
  }
}
}});
  </script>
</body>
</html>
